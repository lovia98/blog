<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>스프링 클라우드 - juhee's 개발과 일상</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="juhee's 개발과 일상" property="og:site_name">
  
    <meta content="스프링 클라우드" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
" property="og:description">
  
  
    <meta content="http://localhost:4000/spring-cloud1/" property="og:url">
  
  
    <meta content="2018-05-28T00:00:00+09:00" property="article:published_time">
    <meta content="http://localhost:4000/about/" property="article:author">
  
  
    <meta content="http://localhost:4000/blog/assets/img/profile.jpg" property="og:image">
  
  
    
    <meta content="Spring" property="article:section">
    
  
  
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="스프링 클라우드">
  
  
    <meta name="twitter:url" content="http://localhost:4000/spring-cloud1/">
  
  
    <meta name="twitter:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
  
  
    <meta name="twitter:image:src" content="http://localhost:4000/blog/assets/img/profile.jpg">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/blog/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/blog/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/blog/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/blog/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/blog/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/blog/assets/css/main.css">
        
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/blog/"><img src="/blog/assets/img/profile.jpg" alt="Juhee Han"></a>
      </div>
      <div class="author-name">Juhee Han</div>
      <p>일상과 개발</p>
    </div>
   <div style="text-align: center">
     <a href="/blog/category/">Categories</a>
    </div>
  </header>
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
<!--          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>-->
        
        
          <li><a href="https://facebook.com/https://www.facebook.com/juhee.han.9847" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
        
          <li class="github"><a href="http://github.com/lovia98" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
        
        
<!--          <li class="email"><a href="mailto:example.david@blog.com"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></li>-->
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2019 &copy; Juhee Han</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
<!--    -->
<!--    -->
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">스프링 클라우드</h1>
        <div class="page-date"><span>2018, May 28&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <p>Spring Cloud 홈페이지에 따르면, MSA와 같은 분산 시스템의 규모가 점차 커지면서 중간에 조정할
수 있는 별도의 서비스가 필요하고, 이 서비스를 쉽게 구축 할 수 있는 프레임웍이라고 소개 되고 있다.
(참고 링크 : <a href="http://projects.spring.io/spring-cloud/" target="_blank">http://projects.spring.io/spring-cloud/</a>)</p>

<p>일단 내가 이해 된 Spring Cloud의 기능 중 하나는 Application에서 필요한 설정 정보(db접속 정보, api도메인 정보등..)를
담은 properties를 배포 없이 수정 가능하다는 것이다.</p>

<p>다른 블로거님이 올려 놓은 정보를 토대로 내가 만든 예제를 정리해본다.
<span class="font14">
<br />( 참고 링크 : <a href="http://blog.leekyoungil.com/?p=352">http://blog.leekyoungil.com/?p=352</a>
<br /><a href="http://jeroenbellen.com/manage-and-reload-spring-application-properties-on-the-fly">
http://jeroenbellen.com/manage-and-reload-spring-application-properties-on-the-fly</a>
<br /><a href="https://projects.spring.io/spring-cloud/spring-cloud.html#customizing-bootstrap-properties">https://projects.spring.io/spring-cloud/spring-cloud.html#customizing-bootstrap-properties</a></span> )</p>

<hr />

<h3 id="공통-config-properties-만들기-github에-생성">공통 config properties 만들기 (gitHub에 생성)</h3>
<p><br /><span class="font14">* 샘플 코드 : <a href="https://github.com/lovia98/spring-cloud-config" target="_blank">https://github.com/lovia98/spring-cloud-config</a></span>
<br />  2개의 product, payment서비스를 위한 2개의 설정이 필요하다고 가정하고 아래 2개의 파일을
만든다.
<br /><span class="font14"><bold>payment-service.yml</bold></span>
<br /><img src="/blog/assets/img/spring/spring_cloud_1.jpg" />
<br /><span class="font14"><bold>product-service.yml</bold> (profile별로 나누어진 상태)</span>
<br /><img src="/blog/assets/img/spring/spring_cloud_2.jpg" /></p>

<hr />

<h3 id="config-server-설정">Config Server 설정</h3>
<ol>
  <li>Cloud Config Server 만들기 (Intellj, maven기준)
<br /><span class="font14">참고 링크 : <a href="https://github.com/lovia98/spring-cloud-example" target="_blank">https://github.com/lovia98/spring-cloud-example</a></span>
    <ul>
      <li>Spring boot project 생성
  <br /><img src="/blog/assets/img/spring/spring_cloud_3.jpg" /></li>
      <li>Dependencies 에서 <bold>Cloud Config &gt; config Server<bold>선택
  <br /><img src="/blog/assets/img/spring/spring_cloud_4.jpg" /></bold></bold></li>
      <li>Application.java에 @EnableConfigServer추가
  <br /><img src="/blog/assets/img/spring/spring_cloud_5.jpg" /></li>
      <li>application.yml 설정
  <br />Spring Cloud guide에서는 bootstrap.yml을 생성하라고 가이드 되어 있는데, bootstrap.yml파일은
  spring cloud application에서 application.yml파일보다 먼저 실행이 된다고 한다.
  <br /><span class="font14">spring.cloud.config.server.git.uri 설정</span>
  <br /><img src="/blog/assets/img/spring/spring_cloud_6.jpg" />
  <br />구글링을 해보니 config설정 properties는 git이 아니여도 application내부의 class path, local file, http uri
  모두 설정이 가능 한것으로 보인다.  상황(회사 방침)에 따라 맞추어 설정하면 될 것 같다.</li>
    </ul>
  </li>
  <li>config server 확인
    <ul>
      <li>uri 패턴 : {config-server-address}/{service-name}/{profiles}
  <br />github의 payment-service.yml은 profile이 나뉘어져 있지 않으므로, {profiles}부분을 default로 하여 호출 한다.
  <br /><img src="/blog/assets/img/spring/spring_cloud_7.jpg" /></li>
      <li>product-service의 config 정보 (profile을 구분하여서 dev, stg로 호출이 가능하다.)
  <br /><img src="/blog/assets/img/spring/spring_cloud_8.jpg" />
  <br /><img src="/blog/assets/img/spring/spring_cloud_9.jpg" /></li>
    </ul>
  </li>
</ol>

<hr />

<h3 id="client-server-설정">Client Server 설정</h3>
<ol>
  <li>Config Server를 참조할 client인 일반적인 Rest Api application을 생성한다.
    <ul>
      <li>pom.xml에 spring-cloud-config-client, spring-boot-starter-actuator 를 추가한다.
<br /><img src="/blog/assets/img/spring/spring_cloud_10.jpg" />
<br />spring-cloud-config-client는 config server로 부터 config정보를 얻어 오기 위해 필요하고,
actuator는 배포없이 config설정 변경이 적용되기 위해 필요하다.   자세한 것은 뒤에 config 수정 테스트를 통해
알게 되니 우선 config정보를 가져오는 부분을 따라가 보자~!</li>
      <li>bootstrap.yml(or application.yml) 생성 및 설정
<br /><img src="/blog/assets/img/spring/spring_cloud_11.jpg" />
<br />1) spring.application.name 을 설정하면 해당 서비스명의 config정보가 적용된다.
<br />2) spring.management.security.enable = false 액츄에이터 보안 처리 false로 설정
<br />3) spring.endpoints.acurator.enabled = true 액츄에이터 endpoints 사용</li>
    </ul>
  </li>
</ol>

<ul>
  <li>
    <p>Rest Controller 생성
<br /> 1) @Value를 통한 config 정보 가져오기
<br /><img src="/blog/assets/img/spring/spring_cloud_12.jpg" />
<br /> 2)@ConfigurationProperties를 통해 config정보를 객체에 담기
<br /><img src="/blog/assets/img/spring/spring_cloud_14.jpg" />
<br /><img src="/blog/assets/img/spring/spring_cloud_15.jpg" /></p>
  </li>
  <li>
    <p>Client Application 실행시 -Dspring.profiles.active=dev로 vm options 추가.
<br />application의 profile을 dev 로 설정 했으니 dev환경의 yml값을 가져오게 된다.
<br /><img src="/blog/assets/img/spring/spring_cloud_17.jpg" width="700" /></p>
  </li>
  <li>
    <p>@Value와 Property객체 설정을 통한 config값 모두 정상적으로 노출 되는 것을 확인 할 수 있다.</p>
  </li>
</ul>
<div class="row">
  <div class="4u 12u$(small)">
    <span class="font14">- @Value를 통한 config값 테스트</span>
    <br /><img src="/blog/assets/img/spring/spring_cloud_13.jpg" />
  </div>
  <div class="6u 12u$(small)">
    <span class="font14">- 객체를 통한 config값 테스트</span>
    <br /><img src="/blog/assets/img/spring/spring_cloud_16.jpg" />
  </div>
</div>

<hr />

<h3 id="ymlor-property-파일-변경시-자동-반영">yml(or property) 파일 변경시 자동 반영</h3>
<p><br />여기까지 gitHub에 push되어 있는 yml파일을 제공해주는 cloud config server 을 만들고 client server에서 읽어 오는 부분을
확인 하였다. 그럼 궁극적으로 확인해 보려고 하는 배포 없는 config 파일 수정을 테스트 해보자.
<br /><span class="font14">( host.domain값을 <bold>item-dev-api1</bold>.myhost.com에서 <bold>item-dev-api</bold>.myhost.com로 변경 )</span>
<br /><img src="/blog/assets/img/spring/spring_cloud_18.jpg" /></p>

<ul>
  <li>
    <p><span class="colorBlueLight">기대하는 것과 다르게 client Server에서는 변경이 반영되지 않는데,
<br />이는 @RefeshScope를 적용한 영역에서만 build없이 적용되기 때문이다.</span></p>
  </li>
  <li>
    <p>확인을 위해 새로운 @RefreshScope를 적용한 Controller를 생성해보자.
<br /><img src="/blog/assets/img/spring/spring_cloud_19.jpg" /></p>
  </li>
  <li>
    <p><span class="colorBlueLight">@RefreshScope가 적용된 controller를 호출해 보지만, 여전히 자동 반영되지 않다. ㅡ.ㅡ;;
<br /><img src="/blog/assets/img/spring/spring_cloud_20.jpg" />
</span>
<br />여기서 client api server를 생성할때 왜 actuator dependency를 추가해준 이유가 나오는데,
boot application을 배포하지 않은 상태에서 build를 하기 위해서는 ‘refresh’라는 endpoint를 통해서만 가능 하기 때문이다.</p>
  </li>
  <li>
    <p>아래와 같이 <i>{client server address}/refresh</i> uri를 POST로 호출하면,
<br /><img src="/blog/assets/img/spring/spring_cloud_21.jpg" />
<br />yml 파일의 변경된 값이 host.domain이라는 것을 응답으로 알 수 있다.</p>
  </li>
  <li>
    <p>@RefreshScope가 적용된 controller를 호출 하면 값이 변경된 것을 확인 할수 있다.
하지만 @RefreshScope가 적용되지 않은 controller는 반영이 되지 않는다.
<br /><img src="/blog/assets/img/spring/spring_cloud_22.jpg" />
<br /><img src="/blog/assets/img/spring/spring_cloud_20.jpg" /></p>
  </li>
</ul>

<p>Spring Cloud는 배포없는 변경을 지원해 주기도 하지만 다른 기능도 여러개 있는 것으로 보이는데, 좀 더 공부가 필요할 것 같다.</p>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=스프링 클라우드&url=http://localhost:4000/spring-cloud1/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=http://localhost:4000/spring-cloud1/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=http://localhost:4000/spring-cloud1/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//mr-brown.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
